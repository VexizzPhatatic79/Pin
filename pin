local player = game.Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
local hasBomb = false -- Flag to check if player has the bomb
local bombHolder = nil -- To keep track of who has the bomb

-- UI setup
local screenGui = Instance.new("ScreenGui", player.PlayerGui)

-- Title setup
local titleLabel = Instance.new("TextLabel", screenGui)
titleLabel.Position = UDim2.new(0.5, -100, 0, 10) -- Position at the top-center of the screen
titleLabel.Size = UDim2.new(0, 200, 0, 50)
titleLabel.Text = "Phoela"
titleLabel.BackgroundTransparency = 1
titleLabel.TextScaled = true
titleLabel.TextColor3 = Color3.new(1, 1, 1)
titleLabel.Font = Enum.Font.SourceSansBold

-- Throw Button setup
local throwButton = Instance.new("TextButton", screenGui)
throwButton.Position = UDim2.new(0.5, -50, 0, 130)
throwButton.Size = UDim2.new(0, 100, 0, 50)
throwButton.Text = "ပစ်မည်"
throwButton.BackgroundColor3 = Color3.new(1, 1, 0) -- Yellow
throwButton.Visible = false -- Hide initially

-- Bomb Alert setup
local bombAlert = Instance.new("TextLabel", screenGui)
bombAlert.Position = UDim2.new(0.5, -50, 0, 80)
bombAlert.Size = UDim2.new(0, 100, 0, 50)
bombAlert.Text = ""
bombAlert.BackgroundColor3 = Color3.new(1, 0, 0) -- Red
bombAlert.Visible = false -- Hide initially

-- Function to find the closest player
local function getClosestPlayer()
    local closestPlayer = nil
    local minDistance = math.huge

    for _, otherPlayer in pairs(game.Players:GetPlayers()) do
        if otherPlayer ~= player and otherPlayer.Character and otherPlayer.Character:FindFirstChild("HumanoidRootPart") then
            local distance = (humanoidRootPart.Position - otherPlayer.Character.HumanoidRootPart.Position).Magnitude
            if distance < minDistance then
                minDistance = distance
                closestPlayer = otherPlayer
            end
        end
    end
    return closestPlayer
end

-- Function to throw the bomb to the closest player
local function throwBoom()
    if hasBomb then
        local closestPlayer = getClosestPlayer()
        if closestPlayer and closestPlayer.Character and closestPlayer.Character:FindFirstChild("HumanoidRootPart") then
            -- Move the bomb object to the closest player
            local bomb = character:FindFirstChild("Bomb") or player.Backpack:FindFirstChild("Bomb")
            if bomb then
                -- Move Bomb to the closest player
                bomb.Parent = closestPlayer.Backpack -- Move bomb to their Backpack
                bombHolder = closestPlayer -- Update bomb holder

                -- Update hasBomb flag
                hasBomb = false
                throwButton.Visible = false -- Hide throw button
                bombAlert.Visible = false -- Hide bomb alert

                -- Bomb transferred, notify the new holder
                local remoteEvent = game.ReplicatedStorage:FindFirstChild("BombTransferred")
                if remoteEvent then
                    remoteEvent:FireServer(closestPlayer) -- Notify server
                end
            end
        end
    end
end

-- Detect when Bomb is added to your backpack or character
local function onBombAdded()
    hasBomb = true -- Set the flag to true when Bomb is received
    bombHolder = player -- The player becomes the bomb holder
    throwButton.Visible = true -- Show throw button if player has bomb
    bombAlert.Text = "ဗုံးရနေပါပြီ!" -- Show bomb alert message
    bombAlert.Visible = true -- Show the alert
end

player.Backpack.ChildAdded:Connect(function(child)
    if child.Name == "Bomb" then
        onBombAdded()
    end
end)

character.ChildAdded:Connect(function(child)
    if child.Name == "Bomb" then
        onBombAdded()
    end
end)

-- Detect when Bomb is removed from your backpack or character
local function onBombRemoved()
    hasBomb = false -- Set the flag to false when Bomb is removed
    throwButton.Visible = false -- Hide the throw button
    bombAlert.Visible = false -- Hide the alert when bomb is removed
end

player.Backpack.ChildRemoved:Connect(function(child)
    if child.Name == "Bomb" then
        onBombRemoved()
    end
end)

character.ChildRemoved:Connect(function(child)
    if child.Name == "Bomb" then
        onBombRemoved()
    end
end)

-- Throw Button functionality
throwButton.MouseButton1Click:Connect(function()
    throwBoom() -- Call the function to throw the bomb
end)

-- Server Event Listener to reset the bomb on the server side
game.ReplicatedStorage:WaitForChild("BombTransferred").OnClientEvent:Connect(function(newBombHolder)
    if newBombHolder == player then
        onBombAdded() -- Show that player now has the bomb
    else
        onBombRemoved() -- Remove bomb from the previous holder
    end
end)
